<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Purchase Slip Manager</title>
    <link rel="icon" type="image/png" href="assets/spslogo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* GLOBAL THEME VARIABLES */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            --light-purple: #f0ebf8;
            --text-primary: #2d3748;
            --bg-light: #f5f7fa;
        }

        body {
            background: var(--bg-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* TOP HEADER BAR */
        .top-bar {
            background: var(--primary-gradient);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .top-bar .logo-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .top-bar .logo-title img {
            width: 50px;
            height: 50px;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }
        .top-bar h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
            font-weight: 600;
        }
        .btn-logout {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        .btn-logout:hover {
            background: white;
            color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* HAMBURGER BUTTON */
        .hamburger-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 5px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 30px;
            height: 30px;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .hamburger-btn span {
            display: block;
            width: 25px;
            height: 3px;
            background: white;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .hamburger-btn:hover {
            transform: scale(1.1);
        }

        .hamburger-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }

        .hamburger-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        /* LAYOUT WITH LEFT SIDEBAR */
        .app-layout {
            display: flex;
            height: calc(100vh - 80px);
            overflow: hidden;
        }

        /* LEFT SIDEBAR NAVIGATION */
        .sidebar {
            width: 250px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            transition: transform 0.3s ease, margin-left 0.3s ease;
            z-index: 100;
        }

        .sidebar.collapsed {
            transform: translateX(-250px);
            margin-left: -250px;
        }

        /* Sidebar Overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }

        .nav-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
            color: var(--text-primary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-item:hover {
            background: var(--light-purple);
            border-left-color: #667eea;
        }

        .nav-item.active {
            background: var(--primary-gradient);
            color: white;
            border-left-color: #764ba2;
        }

        .nav-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        /* MAIN CONTENT AREA */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: var(--bg-light);
        }

        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* CARD CONTAINERS */
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .card-header {
            background: var(--primary-gradient) !important;
            color: white !important;
            font-weight: 600;
            font-size: 16px;
            padding: 12px 18px;
            border: none;
        }
        .card-body {
            background: white;
        }

        /* VIEW MODE CONTAINER */
        .view-mode-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 70vh;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* SECTION HEADERS */
        .view-section {
            margin-bottom: 25px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 15px;
        }
        .view-section:last-child {
            border-bottom: none;
        }
        .view-section h5 {
            background: var(--primary-gradient);
            color: white;
            padding: 10px 18px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        /* TEXT HEADERS (h6, h5 in forms) */
        h6.text-primary,
        h5.text-primary {
            background: var(--primary-gradient);
            color: white !important;
            padding: 10px 18px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        /* MODAL HEADERS */
        .modal-header {
            background: var(--primary-gradient) !important;
            color: white !important;
            border-bottom: none;
        }
        .modal-header .modal-title {
            font-weight: 700;
            font-size: 20px;
        }
        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }

        /* BUTTONS - PRIMARY */
        .btn-primary {
            background: var(--primary-gradient) !important;
            border: none !important;
            font-weight: 600;
            padding: 10px 24px;
            border-radius: 6px;
            transition: all 0.3s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* BUTTONS - SUCCESS */
        .btn-success {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%) !important;
            border: none !important;
            font-weight: 600;
            padding: 10px 24px;
            border-radius: 6px;
            transition: all 0.3s;
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        /* BUTTONS - WARNING */
        .btn-warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%) !important;
            border: none !important;
            font-weight: 600;
            color: white !important;
            padding: 8px 20px;
            border-radius: 6px;
            transition: all 0.3s;
        }
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
        }

        /* BUTTONS - DANGER */
        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%) !important;
            border: none !important;
            font-weight: 600;
            padding: 8px 20px;
            border-radius: 6px;
            transition: all 0.3s;
        }
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
        }

        /* TABLES */
        .view-table {
            width: 100%;
            border-collapse: collapse;
        }
        .view-table td {
            padding: 8px;
            border: 1px solid #e0e0e0;
        }
        .view-table td:first-child {
            font-weight: 600;
            background: var(--light-purple);
            width: 200px;
            color: #764ba2;
        }

        /* PAYMENT HIGHLIGHT */
        .payment-highlight {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #4caf50;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
        }
        .payment-highlight h6 {
            margin: 0 0 10px 0;
            color: #2e7d32;
            font-weight: 700;
        }
        .payment-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 15px;
        }
        .payment-label {
            font-weight: 600;
        }
        .payment-value {
            font-weight: 700;
            color: #2e7d32;
        }

        /* INSTALMENT CARDS */
        .instalment-card {
            background: var(--light-purple);
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }
        .instalment-card h6 {
            margin: 0 0 8px 0;
            color: #764ba2;
            font-size: 14px;
            font-weight: 700;
        }

        /* MODAL FOOTER */
        .modal-footer button {
            min-width: 100px;
            height: 38px;
        }

        /* FORM LABELS */
        .form-label {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        /* FORM CONTROLS */
        .form-control,
        .form-select,
        input,
        textarea {
            caret-color: #2d3748 !important;
            color: #2d3748 !important;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            caret-color: #2d3748 !important;
        }

        /* TABLE HEADERS */
        table thead {
            background: var(--primary-gradient);
            color: white;
        }
        table thead th {
            font-weight: 600;
            padding: 12px;
            border: none;
        }

        /* TABLE COLUMN FIXES - NO WRAPPING */
        table td {
            vertical-align: middle;
        }

        /* Date column - no wrapping */
        table td:nth-child(2) {
            white-space: nowrap;
        }

        /* Actions column - keep buttons in one line */
        table td:last-child {
            white-space: nowrap;
        }

        table td:last-child .btn {
            margin: 2px;
            display: inline-block;
        }

        /* BADGES */
        .badge {
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 6px;
        }
        /* DASHBOARD STYLES */
        .dashboard-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.2);
        }

        .metric-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 10px 0 5px 0;
        }

        .metric-label {
            font-size: 14px;
            color: #718096;
            font-weight: 600;
        }

        .metric-change {
            font-size: 12px;
            margin-top: 8px;
            font-weight: 600;
        }

        .metric-change.positive {
            color: #48bb78;
        }

        .metric-change.negative {
            color: #f56565;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .dashboard-table {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .two-column-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .filter-bar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .filter-bar select,
        .filter-bar input {
            padding: 8px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            min-width: 150px;
        }

        /* Search Container */
        .search-container {
            max-width: 400px;
        }

        .search-container .form-control {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-container .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
        }

        .search-container .form-control::placeholder {
            color: #999;
        }

        .stat-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .stat-badge.success {
            background: #c6f6d5;
            color: #22543d;
        }

        .stat-badge.warning {
            background: #fef5e7;
            color: #744210;
        }

        .stat-badge.danger {
            background: #fed7d7;
            color: #742a2a;
        }

        /* RESPONSIVE DESIGN */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: 0;
                top: 0;
                height: 100%;
                z-index: 1000;
                box-shadow: 4px 0 15px rgba(0,0,0,0.2);
            }

            .sidebar.collapsed {
                transform: translateX(-100%);
            }

            .main-content {
                width: 100%;
            }

            .top-bar h1 {
                font-size: 18px;
            }

            .hamburger-btn {
                margin-right: 5px;
            }

            /* Make table horizontally scrollable on mobile */
            .table-responsive {
                overflow-x: auto;
            }
        }

        @media (max-width: 480px) {
            .top-bar {
                padding: 10px 15px;
            }

            .top-bar h1 {
                font-size: 14px;
            }

            .user-info span {
                display: none;
            }

            table td:last-child .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="logo-title">
            <button class="hamburger-btn" onclick="toggleSidebar()" aria-label="Toggle Menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <img src="assets/spslogo.png" alt="Smart Purchase Slip Logo">
            <h1>Smart Purchase Slip Manager</h1>
        </div>
        <div class="user-info">
            <span id="userName">Welcome, User</span>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="app-layout">
        <!-- Sidebar Overlay for Mobile -->
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <!-- LEFT SIDEBAR NAVIGATION -->
        <div class="sidebar">
            <div class="nav-item active" onclick="switchTab('dashboard')">
                <span class="nav-icon">üìä</span>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" onclick="switchTab('create')">
                <span class="nav-icon">‚ûï</span>
                <span>Create New Slip</span>
            </div>
            <div class="nav-item" onclick="switchTab('view')">
                <span class="nav-icon">üìã</span>
                <span>View All Slips</span>
            </div>
            <div class="nav-item" onclick="switchTab('users')">
                <span class="nav-icon">üë•</span>
                <span>Manage Users</span>
            </div>
        </div>

        <!-- MAIN CONTENT AREA -->
        <div class="main-content">
            <!-- DASHBOARD TAB -->
            <div id="dashboardTab" class="tab-content active">
                <!-- Filter Bar -->
                <div class="filter-bar">
                    <label><strong>Period:</strong></label>
                    <select id="dashboardPeriod" onchange="loadDashboardData()">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month" selected>This Month</option>
                        <option value="year">This Year</option>
                        <option value="all">All Time</option>
                    </select>
                    <button class="btn btn-sm btn-primary" onclick="loadDashboardData()">üîÑ Refresh</button>
                </div>

                <!-- SECTION 1: TOP METRICS -->
                <div class="dashboard-metrics">
                    <div class="metric-card">
                        <div class="metric-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">üåæ</div>
                        <div class="metric-label">Total Paddy Purchased</div>
                        <div class="metric-value" id="totalPaddyQntl">0 Qntl</div>
                        <div class="metric-change positive" id="paddyChange"></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon" style="background: #fef5e7; color: #744210;">üí∞</div>
                        <div class="metric-label">Total Purchase Amount</div>
                        <div class="metric-value" id="totalPurchaseAmount">‚Çπ0</div>
                        <div class="metric-change" id="purchaseChange"></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon" style="background: #fed7d7; color: #742a2a;">üìâ</div>
                        <div class="metric-label">Total Deductions</div>
                        <div class="metric-value" id="totalDeductions">‚Çπ0</div>
                        <div class="metric-change" id="deductionChange"></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon" style="background: #c6f6d5; color: #22543d;">üíµ</div>
                        <div class="metric-label">Net Payable</div>
                        <div class="metric-value" id="netPayable">‚Çπ0</div>
                        <div class="metric-change" id="payableChange"></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon" style="background: #bee3f8; color: #2c5282;">‚úÖ</div>
                        <div class="metric-label">Total Paid</div>
                        <div class="metric-value" id="totalPaid">‚Çπ0</div>
                        <div class="metric-change" id="paidChange"></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon" style="background: #feebc8; color: #7c2d12;">‚è≥</div>
                        <div class="metric-label">Outstanding Balance</div>
                        <div class="metric-value" id="totalOutstanding">‚Çπ0</div>
                        <div class="metric-change" id="outstandingChange"></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon" style="background: #e9d8fd; color: #553c9a;">üìä</div>
                        <div class="metric-label">Avg Effective Rate</div>
                        <div class="metric-value" id="avgEffectiveRate">‚Çπ0/Qntl</div>
                        <div class="metric-change" id="rateChange"></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon" style="background: #fed7e2; color: #97266d;">üìù</div>
                        <div class="metric-label">Total Bills</div>
                        <div class="metric-value" id="totalBills">0</div>
                        <div class="metric-change" id="billsChange"></div>
                    </div>
                </div>

                <!-- SECTION 2: PURCHASE ANALYTICS -->
                <h4 class="mb-3" style="color: var(--text-primary); font-weight: 700;">üìà Purchase Analytics</h4>
                <div class="two-column-charts">
                    <div class="chart-container">
                        <div class="chart-title">Daily Purchase Trend (Qntl)</div>
                        <canvas id="dailyPurchaseChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Purchase Rate Trend (‚Çπ/Qntl)</div>
                        <canvas id="rateTrendChart"></canvas>
                    </div>
                </div>

                <div class="two-column-charts">
                    <div class="chart-container">
                        <div class="chart-title">Deduction Breakdown</div>
                        <canvas id="deductionChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Top 10 Suppliers by Quantity</div>
                        <canvas id="topSuppliersChart"></canvas>
                    </div>
                </div>

                <!-- SECTION 3: PAYMENT DASHBOARD -->
                <h4 class="mb-3 mt-4" style="color: var(--text-primary); font-weight: 700;">üí≥ Payment Dashboard</h4>
                <div class="two-column-charts">
                    <div class="chart-container">
                        <div class="chart-title">Outstanding Ageing</div>
                        <canvas id="ageingChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Payment Mode Split</div>
                        <canvas id="paymentModeChart"></canvas>
                    </div>
                </div>

                <!-- Outstanding Farmer-wise Table -->
                <div class="dashboard-table">
                    <div class="chart-title">Outstanding Payments by Farmer</div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Farmer Name</th>
                                    <th class="text-end">Total Purchase</th>
                                    <th class="text-end">Paid</th>
                                    <th class="text-end">Outstanding</th>
                                    <th>Last Payment</th>
                                    <th class="text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody id="outstandingTableBody">
                                <tr><td colspan="6" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- SECTION 4: GODOWN & STOCK -->
                <h4 class="mb-3 mt-4" style="color: var(--text-primary); font-weight: 700;">üè¢ Godown & Stock Dashboard</h4>
                <div class="two-column-charts">
                    <div class="chart-container">
                        <div class="chart-title">Stock by Godown</div>
                        <canvas id="godownStockChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Expected Rice Output</div>
                        <canvas id="riceOutputChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- CREATE TAB -->
            <div id="createTab" class="tab-content">
                <iframe src="http://localhost:5000/" style="width:100%; height:85vh; border:none; background:white; border-radius:10px;"></iframe>
            </div>

        <!-- VIEW TAB -->
        <div id="viewTab" class="tab-content">
            <div class="card">
                <div class="card-body">
                    <h3 class="mb-4">All Purchase Slips</h3>

                    <!-- Search Bar -->
                    <div class="search-container mb-3">
                        <input
                            type="text"
                            id="searchSlips"
                            class="form-control"
                            placeholder="üîç Search by Party Name..."
                            onkeyup="filterSlips()"
                        >
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Bill No</th>
                                    <th>Date</th>
                                    <th>Party Name</th>
                                    <!-- <th>Material</th> -->
                                    <th>Final Wt (KG)</th>
                                    <th>Rate Basis</th>
                                    <!-- <th>Purchase Amt</th> -->
                                    <th>Payable</th>
                                    <th>Paid</th>
                                    <th>Balance</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="slipsTableBody">
                                <tr><td colspan="9" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- USERS TAB -->
        <div id="usersTab" class="tab-content">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>User Management</h3>
                        <button class="btn btn-primary" onclick="showAddUserModal()" id="addUserBtn">Add New User</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Full Name</th>
                                    <th>Role</th>
                                    <th>Last Login</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr><td colspan="6" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        </div> <!-- Close main-content -->
    </div> <!-- Close app-layout -->

    <!-- Enhanced View Slip Modal -->
    <div class="modal fade" id="viewSlipModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">View Purchase Slip Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="viewSlipContent">
                    Loading...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="showEditSlipModal()">Edit Slip</button>
                    <button type="button" class="btn btn-success" onclick="printCurrentSlip()">Print</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Slip Modal with All 5 Instalments -->
    <div class="modal fade" id="editSlipModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Purchase Slip</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <form id="editSlipForm">
                        <!-- Company Details -->
                        <h6 class="text-primary mb-3">Company Details</h6>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Company Name</label>
                                <input type="text" class="form-control" id="edit_company_name" name="company_name">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Company Address</label>
                                <input type="text" class="form-control" id="edit_company_address" name="company_address">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Company GST No</label>
                                <input type="text" class="form-control" id="edit_company_gst_no" name="company_gst_no">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Company Mobile No</label>
                                <input type="text" class="form-control" id="edit_company_mobile_no" name="company_mobile_no">
                            </div>
                        </div>

                        <!-- Basic Details -->
                        <h6 class="text-primary mb-3">Basic Details</h6>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Date</label>
                                <input type="datetime-local" class="form-control" id="edit_date" name="date">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Vehicle No</label>
                                <input type="text" class="form-control" id="edit_vehicle_no" name="vehicle_no">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Party Name</label>
                                <input type="text" class="form-control" id="edit_party_name" name="party_name">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Mobile Number</label>
                                <input type="text" class="form-control" id="edit_mobile_number" name="mobile_number">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Material Name</label>
                                <input type="text" class="form-control" id="edit_material_name" name="material_name">
                            </div>
                            <!-- <div class="col-md-4">
                                <label class="form-label">Ticket No</label>
                                <input type="text" class="form-control" id="edit_ticket_no" name="ticket_no">
                            </div> -->
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Broker</label>
                                <input type="text" class="form-control" id="edit_broker" name="broker">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Terms of Delivery</label>
                                <input type="text" class="form-control" id="edit_terms_of_delivery" name="terms_of_delivery">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Sup. Inv. No</label>
                                <input type="text" class="form-control" id="edit_sup_inv_no" name="sup_inv_no">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">GST No</label>
                                <input type="text" class="form-control" id="edit_gst_no" name="gst_no">
                            </div>
                        </div>

                        <!-- Quantity Details -->
                        <h6 class="text-primary mb-3">Quantity Details</h6>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label class="form-label">Bags</label>
                                <input type="number" step="1" class="form-control" id="edit_bags" name="bags">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Avg Bag Weight (KG)</label>
                                <input type="number" step="0.01" class="form-control" id="edit_avg_bag_weight" name="avg_bag_weight">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Net Weight (KG)</label>
                                <input type="number" step="0.01" class="form-control" id="edit_net_weight_kg" name="net_weight_kg">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Gunny Weight (KG)</label>
                                <input type="number" step="0.01" class="form-control" id="edit_gunny_weight_kg" name="gunny_weight_kg">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Final Weight (KG)</label>
                                <input type="number" step="0.01" class="form-control" id="edit_final_weight_kg" name="final_weight_kg">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Weight (Quintal)</label>
                                <input type="number" step="0.001" class="form-control" id="edit_weight_quintal" name="weight_quintal">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Weight (Khandi)</label>
                                <input type="number" step="0.001" class="form-control" id="edit_weight_khandi" name="weight_khandi">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Rate Basis</label>
                                <select class="form-select" id="edit_rate_basis" name="rate_basis">
                                    <option value="Quintal">Quintal</option>
                                    <option value="Khandi">Khandi</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Rate Value</label>
                                <input type="number" step="0.01" class="form-control" id="edit_rate_value" name="rate_value">
                            </div>
                        </div>

                        <!-- Financial Calculation -->
                        <h6 class="text-primary mb-3">Financial Calculation</h6>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">Total Purchase Amount (‚Çπ)</label>
                                <input type="number" step="0.01" class="form-control" id="edit_total_purchase_amount" name="total_purchase_amount" readonly style="background-color: #f0f8ff; font-weight: bold; font-size: 1.1em;">
                            </div>
                        </div>

                        <!-- Deductions -->
                        <h6 class="text-primary mb-3">Deductions</h6>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Bank Commission</label>
                                <input type="number" step="0.01" class="form-control" id="edit_bank_commission" name="bank_commission">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Postage</label>
                                <input type="number" step="0.01" class="form-control" id="edit_postage" name="postage">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Batav %</label>
                                <input type="number" step="0.01" class="form-control" id="edit_batav_percent" name="batav_percent">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Shortage %</label>
                                <input type="number" step="0.01" class="form-control" id="edit_shortage_percent" name="shortage_percent">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Dalali Rate (Rs per 100 KG)</label>
                                <input type="number" step="0.01" class="form-control" id="edit_dalali_rate" name="dalali_rate">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Hamali Rate (Rs per 100 KG)</label>
                                <input type="number" step="0.01" class="form-control" id="edit_hammali_rate" name="hammali_rate">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label class="form-label">Freight</label>
                                <input type="number" step="0.01" class="form-control" id="edit_freight" name="freight">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Rate Diff</label>
                                <input type="number" step="0.01" class="form-control" id="edit_rate_diff" name="rate_diff">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Quality Diff</label>
                                <input type="number" step="0.01" class="form-control" id="edit_quality_diff" name="quality_diff">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Moisture Ded.</label>
                                <input type="number" step="0.01" class="form-control" id="edit_moisture_ded" name="moisture_ded">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Moisture %</label>
                                <input type="number" step="0.01" class="form-control" id="edit_moisture_percent" name="moisture_percent">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Moisture KG</label>
                                <input type="number" step="0.01" class="form-control" id="edit_moisture_kg" name="moisture_kg">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">Moisture Ded. Comment</label>
                                <input type="text" class="form-control" id="edit_moisture_ded_comment" name="moisture_ded_comment" placeholder="Optional comment about moisture deduction">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">TDS</label>
                                <input type="number" step="0.01" class="form-control" id="edit_tds" name="tds">
                            </div>
                        </div>

                        <!-- All 5 Instalments with All Fields -->
                        <h6 class="text-primary mb-3">Payment Instalments</h6>

                        <!-- Instalment 1 -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">Instalment 1</div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-md-3">
                                        <label class="form-label">Date</label>
                                        <input type="datetime-local" class="form-control" id="edit_instalment_1_date" name="instalment_1_date">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Amount</label>
                                        <input type="number" step="0.01" class="form-control" id="edit_instalment_1_amount" name="instalment_1_amount">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Payment Method</label>
                                        <select class="form-select" id="edit_instalment_1_payment_method" name="instalment_1_payment_method">
                                            <option value="">Select</option>
                                            <option value="Cash">Cash</option>
                                            <option value="Cheque">Cheque</option>
                                            <option value="NEFT">NEFT</option>
                                            <option value="RTGS">RTGS</option>
                                            <option value="IMPS">IMPS</option>
                                            <option value="UPI">UPI</option>
                                            <option value="Bank Transfer">Bank Transfer</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Payment Bank Account</label>
                                        <input type="text" class="form-control" id="edit_instalment_1_payment_bank_account" name="instalment_1_payment_bank_account">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <label class="form-label">Comment</label>
                                        <input type="text" class="form-control" id="edit_instalment_1_comment" name="instalment_1_comment">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Instalment 2 -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">Instalment 2</div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-md-3">
                                        <label class="form-label">Date</label>
                                        <input type="datetime-local" class="form-control" id="edit_instalment_2_date" name="instalment_2_date">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Amount</label>
                                        <input type="number" step="0.01" class="form-control" id="edit_instalment_2_amount" name="instalment_2_amount">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Payment Method</label>
                                        <select class="form-select" id="edit_instalment_2_payment_method" name="instalment_2_payment_method">
                                            <option value="">Select</option>
                                            <option value="Cash">Cash</option>
                                            <option value="Cheque">Cheque</option>
                                            <option value="NEFT">NEFT</option>
                                            <option value="RTGS">RTGS</option>
                                            <option value="IMPS">IMPS</option>
                                            <option value="UPI">UPI</option>
                                            <option value="Bank Transfer">Bank Transfer</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Payment Bank Account</label>
                                        <input type="text" class="form-control" id="edit_instalment_2_payment_bank_account" name="instalment_2_payment_bank_account">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <label class="form-label">Comment</label>
                                        <input type="text" class="form-control" id="edit_instalment_2_comment" name="instalment_2_comment">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Instalment 3 -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">Instalment 3</div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-md-3">
                                        <label class="form-label">Date</label>
                                        <input type="datetime-local" class="form-control" id="edit_instalment_3_date" name="instalment_3_date">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Amount</label>
                                        <input type="number" step="0.01" class="form-control" id="edit_instalment_3_amount" name="instalment_3_amount">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Payment Method</label>
                                        <select class="form-select" id="edit_instalment_3_payment_method" name="instalment_3_payment_method">
                                            <option value="">Select</option>
                                            <option value="Cash">Cash</option>
                                            <option value="Cheque">Cheque</option>
                                            <option value="NEFT">NEFT</option>
                                            <option value="RTGS">RTGS</option>
                                            <option value="IMPS">IMPS</option>
                                            <option value="UPI">UPI</option>
                                            <option value="Bank Transfer">Bank Transfer</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Payment Bank Account</label>
                                        <input type="text" class="form-control" id="edit_instalment_3_payment_bank_account" name="instalment_3_payment_bank_account">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <label class="form-label">Comment</label>
                                        <input type="text" class="form-control" id="edit_instalment_3_comment" name="instalment_3_comment">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Instalment 4 -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">Instalment 4</div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-md-3">
                                        <label class="form-label">Date</label>
                                        <input type="datetime-local" class="form-control" id="edit_instalment_4_date" name="instalment_4_date">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Amount</label>
                                        <input type="number" step="0.01" class="form-control" id="edit_instalment_4_amount" name="instalment_4_amount">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Payment Method</label>
                                        <select class="form-select" id="edit_instalment_4_payment_method" name="instalment_4_payment_method">
                                           <option value="">Select</option>
                                            <option value="Cash">Cash</option>
                                            <option value="Cheque">Cheque</option>
                                            <option value="NEFT">NEFT</option>
                                            <option value="RTGS">RTGS</option>
                                            <option value="IMPS">IMPS</option>
                                            <option value="UPI">UPI</option>
                                            <option value="Bank Transfer">Bank Transfer</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Payment Bank Account</label>
                                        <input type="text" class="form-control" id="edit_instalment_4_payment_bank_account" name="instalment_4_payment_bank_account">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <label class="form-label">Comment</label>
                                        <input type="text" class="form-control" id="edit_instalment_4_comment" name="instalment_4_comment">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Instalment 5 -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">Instalment 5</div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-md-3">
                                        <label class="form-label">Date</label>
                                        <input type="datetime-local" class="form-control" id="edit_instalment_5_date" name="instalment_5_date">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Amount</label>
                                        <input type="number" step="0.01" class="form-control" id="edit_instalment_5_amount" name="instalment_5_amount">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Payment Method</label>
                                        <select class="form-select" id="edit_instalment_5_payment_method" name="instalment_5_payment_method">
                                            <option value="">Select</option>
                                            <option value="Cash">Cash</option>
                                            <option value="Cheque">Cheque</option>
                                            <option value="NEFT">NEFT</option>
                                            <option value="RTGS">RTGS</option>
                                            <option value="IMPS">IMPS</option>
                                            <option value="UPI">UPI</option>
                                            <option value="Bank Transfer">Bank Transfer</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Payment Bank Account</label>
                                        <input type="text" class="form-control" id="edit_instalment_5_payment_bank_account" name="instalment_5_payment_bank_account">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <label class="form-label">Comment</label>
                                        <input type="text" class="form-control" id="edit_instalment_5_comment" name="instalment_5_comment">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Comments -->
                        <h6 class="text-primary mb-3">Additional Comments</h6>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">Quality Difference Comment</label>
                                <textarea class="form-control" id="edit_quality_diff_comment" name="quality_diff_comment" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">Paddy Unloading Godown</label>
                                <textarea class="form-control" id="edit_paddy_unloading_godown" name="paddy_unloading_godown" rows="2"></textarea>
                            </div>
                        </div>

                        <!-- Signatures -->
                        <h6 class="text-primary mb-3">Signatures</h6>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Prepared By</label>
                                <input type="text" class="form-control" id="edit_prepared_by" name="prepared_by">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Authorised Sign</label>
                                <input type="text" class="form-control" id="edit_authorised_sign" name="authorised_sign">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="saveSlipEdits()">Save Changes</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" id="newUsername" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="newFullName">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role</label>
                            <select class="form-select" id="newRole">
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="addUser()">Add User</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" id="editUsername" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="editFullName">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role</label>
                            <select class="form-select" id="editUserRole">
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">New Password (leave blank to keep current)</label>
                            <input type="password" class="form-control" id="editUserPassword">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="editUserStatus">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="updateUser()">Update User</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" style="border: 2px solid #dc3545;">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">Are you sure you want to delete this purchase slip?</p>
                    <p class="mb-3"><strong>This action cannot be undone.</strong></p>
                    <p class="mb-2">To confirm deletion, please type <strong>delete</strong> in the box below:</p>
                    <input type="text" class="form-control" id="deleteConfirmText" placeholder="Type 'delete' to confirm">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete Slip</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentViewSlipId = null;
        let currentSlipData = null;

        // Get current user from localStorage
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const isAdmin = user.role === 'admin';
        document.getElementById('userName').textContent = `Welcome, ${user.full_name || user.username}`;

        // Show/hide admin-only buttons
        if (!isAdmin) {
            const addUserBtn = document.getElementById('addUserBtn');
            if (addUserBtn) addUserBtn.style.display = 'none';
        }

        function switchTab(tab) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            if (tab === 'dashboard') {
                document.querySelector('.nav-item:nth-child(1)').classList.add('active');
                document.getElementById('dashboardTab').classList.add('active');
                loadDashboardData();
            } else if (tab === 'create') {
                document.querySelector('.nav-item:nth-child(2)').classList.add('active');
                document.getElementById('createTab').classList.add('active');
            } else if (tab === 'view') {
                document.querySelector('.nav-item:nth-child(3)').classList.add('active');
                document.getElementById('viewTab').classList.add('active');
                loadAllSlips();
            } else if (tab === 'users') {
                document.querySelector('.nav-item:nth-child(4)').classList.add('active');
                document.getElementById('usersTab').classList.add('active');
                loadAllUsers();
            }

            // Auto-close sidebar on mobile after navigation
            if (window.innerWidth <= 768) {
                const sidebar = document.querySelector('.sidebar');
                const hamburgerBtn = document.querySelector('.hamburger-btn');
                const overlay = document.querySelector('.sidebar-overlay');

                if (!sidebar.classList.contains('collapsed')) {
                    sidebar.classList.add('collapsed');
                    hamburgerBtn.classList.remove('active');
                    overlay.classList.remove('active');
                }
            }
        }

        function logout() {
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const hamburgerBtn = document.querySelector('.hamburger-btn');
            const overlay = document.querySelector('.sidebar-overlay');

            sidebar.classList.toggle('collapsed');
            hamburgerBtn.classList.toggle('active');

            // Toggle overlay on mobile
            if (window.innerWidth <= 768) {
                overlay.classList.toggle('active');
            }
        }

        // Close sidebar when clicking outside on mobile
        window.addEventListener('resize', function() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            const hamburgerBtn = document.querySelector('.hamburger-btn');

            if (window.innerWidth > 768) {
                overlay.classList.remove('active');
                sidebar.classList.remove('collapsed');
                hamburgerBtn.classList.remove('active');
            }
        });

        async function loadAllSlips() {
            try {
                const response = await fetch('http://localhost:5000/api/slips');
                const result = await response.json();

                const tbody = document.getElementById('slipsTableBody');
                tbody.innerHTML = '';

                if (result.success && result.slips.length > 0) {
                    result.slips.forEach(slip => {
                        const row = `
                            <tr>
                                <td>${slip.bill_no}</td>
                                <td>${slip.date || '-'}</td>
                                <td>${slip.party_name || '-'}</td>
                                <td>${parseFloat(slip.final_weight_kg || 0).toFixed(2)}</td>
                                <td>${slip.rate_basis || 'Quintal'}</td>
                                <td>‚Çπ${parseFloat(slip.payable_amount || 0).toFixed(2)}</td>
                                <td>‚Çπ${parseFloat(slip.total_paid_amount || 0).toFixed(2)}</td>
                                <td>‚Çπ${parseFloat(slip.balance_amount || 0).toFixed(2)}</td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="viewSlip(${slip.id})">View</button>
                                    <button class="btn btn-sm btn-success" onclick="printSlipDirect(${slip.id}, '${slip.mobile_number || ''}', '${slip.bill_no}')">Print</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteSlip(${slip.id})">Delete</button>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="11" class="text-center">No slips found</td></tr>';
                }
            } catch (error) {
                console.error('Error loading slips:', error);
                document.getElementById('slipsTableBody').innerHTML = '<tr><td colspan="11" class="text-center text-danger">Error loading slips</td></tr>';
            }
        }

        function filterSlips() {
            const searchInput = document.getElementById('searchSlips');
            const filter = searchInput.value.toLowerCase().trim();
            const table = document.getElementById('slipsTableBody');
            const rows = table.getElementsByTagName('tr');
            let visibleCount = 0;

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const partyNameCell = row.getElementsByTagName('td')[2]; // Party Name is the 3rd column (index 2)

                if (partyNameCell) {
                    const partyName = partyNameCell.textContent || partyNameCell.innerText;

                    if (partyName.toLowerCase().indexOf(filter) > -1) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                }
            }

            // Show "No results" message if no matches found
            if (filter !== '' && visibleCount === 0 && rows.length > 0) {
                // Check if the first row is not already a "no slips" message
                if (rows[0] && rows[0].cells.length > 1) {
                    const noResultsRow = document.createElement('tr');
                    noResultsRow.id = 'noResultsRow';
                    noResultsRow.innerHTML = '<td colspan="9" class="text-center text-muted">No matching slips found for "' + searchInput.value + '"</td>';

                    // Remove existing no results row if present
                    const existingNoResults = document.getElementById('noResultsRow');
                    if (existingNoResults) {
                        existingNoResults.remove();
                    }

                    table.appendChild(noResultsRow);
                }
            } else {
                // Remove no results row when results are found
                const existingNoResults = document.getElementById('noResultsRow');
                if (existingNoResults) {
                    existingNoResults.remove();
                }
            }
        }

        async function viewSlip(slipId) {
            currentViewSlipId = slipId;
            try {
                const response = await fetch(`http://localhost:5000/api/slip/${slipId}`);
                const result = await response.json();

                if (result.success) {
                    currentSlipData = result.slip;
                    const slip = result.slip;

                    // Generate instalment display with all 5 fields
                    let instalmentHTML = '';
                    for (let i = 1; i <= 5; i++) {
                        const date = slip[`instalment_${i}_date`];
                        const amount = slip[`instalment_${i}_amount`];
                        const paymentMethod = slip[`instalment_${i}_payment_method`];
                        const paymentBankAccount = slip[`instalment_${i}_payment_bank_account`];
                        const comment = slip[`instalment_${i}_comment`];

                        if (date || amount > 0 || paymentMethod || paymentBankAccount || comment) {
                            instalmentHTML += `
                                <div class="instalment-card">
                                    <h6>Instalment ${i}</h6>
                                    <div><strong>Date:</strong> ${date || '-'}</div>
                                    <div><strong>Amount:</strong> ‚Çπ${parseFloat(amount || 0).toFixed(2)}</div>
                                    <div><strong>Payment Method:</strong> ${paymentMethod || '-'}</div>
                                    <div><strong>Payment Bank Account:</strong> ${paymentBankAccount || '-'}</div>
                                    <div><strong>Comment:</strong> ${comment || '-'}</div>
                                </div>
                            `;
                        }
                    }

                    // Create comprehensive view with proper tables
                    const content = `
                        <div class="view-mode-container">
                            <!-- Payment Summary -->
                            <div class="payment-highlight">
                                <h6>üí∞ Payment Summary</h6>
                                <div class="payment-row">
                                    <span class="payment-label">Payable Amount:</span>
                                    <span class="payment-value">‚Çπ${parseFloat(slip.payable_amount || 0).toFixed(2)}</span>
                                </div>
                                <div class="payment-row">
                                    <span class="payment-label">Total Paid Amount:</span>
                                    <span class="payment-value">‚Çπ${parseFloat(slip.total_paid_amount || 0).toFixed(2)}</span>
                                </div>
                                <div class="payment-row">
                                    <span class="payment-label">Balance Amount:</span>
                                    <span class="payment-value" style="font-size: 18px;">‚Çπ${parseFloat(slip.balance_amount || 0).toFixed(2)}</span>
                                </div>
                            </div>

                            <div class="view-section">
                                <h5>Company & Document Details</h5>
                                <table class="view-table">
                                    <tr><td>Company Name</td><td>${slip.company_name || '-'}</td></tr>
                                    <tr><td>Company Address</td><td>${slip.company_address || '-'}</td></tr>
                                    <tr><td>Company GST No</td><td>${slip.company_gst_no || '-'}</td></tr>
                                    <tr><td>Company Mobile No</td><td>${slip.company_mobile_no || '-'}</td></tr>
                                    <tr><td>Document Type</td><td>${slip.document_type || 'Purchase Slip'}</td></tr>
                                </table>
                            </div>

                            <div class="view-section">
                                <h5>Basic Information</h5>
                                <table class="view-table">
                                    <tr><td>Bill No</td><td>${slip.bill_no}</td></tr>
                                    <tr><td>Date</td><td>${slip.date || '-'}</td></tr>
                                    <tr><td>Vehicle No</td><td>${slip.vehicle_no || '-'}</td></tr>
                                </table>
                            </div>
                            <div class="view-section">
                                <h5>Party Details</h5>
                                <table class="view-table">
                                    <tr><td>Party Name</td><td>${slip.party_name || '-'}</td></tr>
                                    
                                    <tr><td>Material</td><td>${slip.material_name || '-'}</td></tr>
                                    <tr><td>Broker</td><td>${slip.broker || '-'}</td></tr>
                                    <tr><td>Terms of Delivery</td><td>${slip.terms_of_delivery || '-'}</td></tr>
                                    <tr><td>Sup. Inv. No</td><td>${slip.sup_inv_no || '-'}</td></tr>
                                    <tr><td>GST No</td><td>${slip.gst_no || '-'}</td></tr>
                                    <tr><td>Mobile Number</td><td>${slip.mobile_number || '-'}</td></tr>
                                </table>
                            </div>

                            <div class="view-section">
                                <h5>Weight & Rate Details</h5>
                                <table class="view-table">
                                    <tr><td>Bags</td><td>${slip.bags || 0}</td></tr>
                                    <tr><td>Avg Bag Weight</td><td>${slip.avg_bag_weight || 0} kg</td></tr>
                                    <tr><td>Net Weight (KG)</td><td>${slip.net_weight_kg || 0} kg</td></tr>
                                    <tr><td>Gunny Weight (KG)</td><td>${slip.gunny_weight_kg || 0} kg</td></tr>
                                    <tr><td>Final Weight (KG)</td><td><strong>${slip.final_weight_kg || 0} kg</strong></td></tr>
                                    <tr><td>Weight (Quintal)</td><td>${slip.weight_quintal || 0}</td></tr>
                                    <tr><td>Weight (Khandi)</td><td>${slip.weight_khandi || 0}</td></tr>
                                    <tr><td>Rate Basis</td><td>${slip.rate_basis || 'Quintal'}</td></tr>
                                    <tr><td>Rate Value</td><td>‚Çπ${slip.rate_value || 0}</td></tr>
                                </table>
                            </div>

                            <div class="view-section">
                                <h5>Financial Details</h5>
                                <table class="view-table">
                                    <tr><td>Total Purchase Amount</td><td><strong>‚Çπ${slip.total_purchase_amount || 0}</strong></td></tr>
                                    <tr><td>Bank Commission</td><td>‚Çπ${slip.bank_commission || 0}</td></tr>
                                    <tr><td>Postage</td><td>‚Çπ${slip.postage || 0}</td></tr>
                                    <tr><td>Batav (${slip.batav_percent || 0}%)</td><td>‚Çπ${slip.batav || 0}</td></tr>
                                    <tr><td>Dalali Rate (Rs per 100 KG)</td><td>‚Çπ${slip.dalali_rate || 0}</td></tr>
                                    <tr><td>Dalali Amount</td><td>‚Çπ${slip.dalali || 0}</td></tr>
                                    <tr><td>Hamali Rate (Rs per 100 KG)</td><td>‚Çπ${slip.hammali_rate || 0}</td></tr>
                                    <tr><td>Hamali Amount</td><td>‚Çπ${slip.hammali || 0}</td></tr>
                                    <tr><td>Freight</td><td>‚Çπ${slip.freight || 0}</td></tr>
                                    <tr><td>Rate Diff</td><td>‚Çπ${slip.rate_diff || 0}</td></tr>
                                    <tr><td>Quality Diff</td><td>‚Çπ${slip.quality_diff || 0}</td></tr>
                                    <tr><td>Moisture Ded</td><td>‚Çπ${slip.moisture_ded || 0}</td></tr>
                                    <tr><td>Moisture %</td><td>${slip.moisture_percent || 0}%</td></tr>
                                    <tr><td>Moisture KG</td><td>${slip.moisture_kg || 0} kg</td></tr>
                                    ${slip.moisture_ded_comment ? `<tr><td>Moisture Ded. Comment</td><td>${slip.moisture_ded_comment}</td></tr>` : ''}
                                    <tr><td>TDS</td><td>‚Çπ${slip.tds || 0}</td></tr>
                                    <tr><td>Total Deduction</td><td><strong>‚Çπ${slip.total_deduction || 0}</strong></td></tr>
                                </table>
                            </div>

                            ${instalmentHTML ? `
                            <div class="view-section">
                                <h5>Payment Instalments</h5>
                                ${instalmentHTML}
                            </div>
                            ` : ''}

                            ${slip.quality_diff_comment || slip.paddy_unloading_godown ? `
                            <div class="view-section">
                                <h5>Additional Comments</h5>
                                ${slip.quality_diff_comment ? `<p><strong>Quality Diff:</strong> ${slip.quality_diff_comment}</p>` : ''}
                                ${slip.paddy_unloading_godown ? `<p><strong>Paddy Godown:</strong> ${slip.paddy_unloading_godown}</p>` : ''}
                            </div>
                            ` : ''}

                            <div class="view-section">
                                <h5>Signatures</h5>
                                <table class="view-table">
                                    <tr><td>Prepared By</td><td>${slip.prepared_by || '-'}</td></tr>
                                    <tr><td>Authorised Sign</td><td>${slip.authorised_sign || '-'}</td></tr>
                                </table>
                            </div>
                        </div>
                    `;

                    document.getElementById('viewSlipContent').innerHTML = content;
                    new bootstrap.Modal(document.getElementById('viewSlipModal')).show();
                }
            } catch (error) {
                console.error('Error viewing slip:', error);
                alert('Error loading slip details');
            }
        }

        function formatDateForInput(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '';
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function showEditSlipModal() {
            if (!currentSlipData) return;

            const slip = currentSlipData;

            // Company Details
            document.getElementById('edit_company_name').value = slip.company_name || '';
            document.getElementById('edit_company_address').value = slip.company_address || '';
            document.getElementById('edit_company_gst_no').value = slip.company_gst_no || '';
            document.getElementById('edit_company_mobile_no').value = slip.company_mobile_no || '';

            // Basic Details
            document.getElementById('edit_date').value = formatDateForInput(slip.date);
            document.getElementById('edit_vehicle_no').value = slip.vehicle_no || '';
            document.getElementById('edit_party_name').value = slip.party_name || '';
            document.getElementById('edit_mobile_number').value = slip.mobile_number || '';
            document.getElementById('edit_material_name').value = slip.material_name || '';
            // document.getElementById('edit_ticket_no').value = slip.ticket_no || '';
            document.getElementById('edit_broker').value = slip.broker || '';
            document.getElementById('edit_terms_of_delivery').value = slip.terms_of_delivery || '';
            document.getElementById('edit_sup_inv_no').value = slip.sup_inv_no || '';
            document.getElementById('edit_gst_no').value = slip.gst_no || '';

            // Quantity Details
            document.getElementById('edit_bags').value = slip.bags || 0;
            document.getElementById('edit_avg_bag_weight').value = slip.avg_bag_weight || 0;
            document.getElementById('edit_net_weight_kg').value = slip.net_weight_kg || 0;
            document.getElementById('edit_gunny_weight_kg').value = slip.gunny_weight_kg || 0;
            document.getElementById('edit_final_weight_kg').value = slip.final_weight_kg || 0;
            document.getElementById('edit_weight_quintal').value = slip.weight_quintal || 0;
            document.getElementById('edit_weight_khandi').value = slip.weight_khandi || 0;
            document.getElementById('edit_rate_basis').value = slip.rate_basis || 'Quintal';
            document.getElementById('edit_rate_value').value = slip.rate_value || 0;

            // Financial Calculation
            document.getElementById('edit_total_purchase_amount').value = slip.total_purchase_amount || 0;

            // Deductions
            document.getElementById('edit_bank_commission').value = slip.bank_commission || 0;
            document.getElementById('edit_postage').value = slip.postage || 0;
            document.getElementById('edit_batav_percent').value = slip.batav_percent || 0;
            document.getElementById('edit_shortage_percent').value = slip.shortage_percent || 0;
            document.getElementById('edit_dalali_rate').value = slip.dalali_rate || 0;
            document.getElementById('edit_hammali_rate').value = slip.hammali_rate || 0;
            document.getElementById('edit_freight').value = slip.freight || 0;
            document.getElementById('edit_rate_diff').value = slip.rate_diff || 0;
            document.getElementById('edit_quality_diff').value = slip.quality_diff || 0;
            document.getElementById('edit_moisture_ded').value = slip.moisture_ded || 0;
            document.getElementById('edit_moisture_percent').value = slip.moisture_percent || 0;
            document.getElementById('edit_moisture_kg').value = slip.moisture_kg || 0;
            document.getElementById('edit_moisture_ded_comment').value = slip.moisture_ded_comment || '';
            document.getElementById('edit_tds').value = slip.tds || 0;

            // All 5 instalments with all 5 fields
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`edit_instalment_${i}_date`).value = formatDateForInput(slip[`instalment_${i}_date`]);
                document.getElementById(`edit_instalment_${i}_amount`).value = slip[`instalment_${i}_amount`] || '';
                document.getElementById(`edit_instalment_${i}_payment_method`).value = slip[`instalment_${i}_payment_method`] || '';
                document.getElementById(`edit_instalment_${i}_payment_bank_account`).value = slip[`instalment_${i}_payment_bank_account`] || '';
                document.getElementById(`edit_instalment_${i}_comment`).value = slip[`instalment_${i}_comment`] || '';
            }

            // Comments
            document.getElementById('edit_quality_diff_comment').value = slip.quality_diff_comment || '';
            document.getElementById('edit_paddy_unloading_godown').value = slip.paddy_unloading_godown || '';

            // Signatures
            document.getElementById('edit_prepared_by').value = slip.prepared_by || '';
            document.getElementById('edit_authorised_sign').value = slip.authorised_sign || '';

            // Hide view modal and show edit modal
            bootstrap.Modal.getInstance(document.getElementById('viewSlipModal')).hide();
            new bootstrap.Modal(document.getElementById('editSlipModal')).show();
        }

        async function saveSlipEdits() {
            if (!currentViewSlipId) return;

            const formData = new FormData(document.getElementById('editSlipForm'));
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });

            try {
                const response = await fetch(`http://localhost:5000/api/slip/${currentViewSlipId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert('Slip updated successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('editSlipModal')).hide();
                    loadAllSlips();
                    currentViewSlipId = null;
                    currentSlipData = null;
                } else {
                    alert('Error updating slip: ' + result.message);
                }
            } catch (error) {
                console.error('Error updating slip:', error);
                alert('Error updating slip');
            }
        }

        function printCurrentSlip() {
            if (currentViewSlipId) {
                printSlipDirect(currentViewSlipId);
            }
        }

        function printSlipDirect(slipId, mobileNumber, billNo) {
            // Open print preview in new window with WhatsApp sharing option
            const mobile = mobileNumber || (currentSlipData ? currentSlipData.mobile_number : null);
            const bill = billNo || (currentSlipData ? currentSlipData.bill_no : null);

            // Create a custom print preview window with WhatsApp sharing
            const printWindow = window.open('', '_blank', 'width=900,height=1200');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Purchase Slip ${slipId}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body {
                            background: #525252;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                            overflow: hidden;
                        }
                        #toolbar {
                            position: fixed;
                            top: 0;
                            left: 0;
                            right: 0;
                            background: #323639;
                            padding: 12px 20px;
                            display: flex;
                            gap: 12px;
                            justify-content: center;
                            align-items: center;
                            z-index: 1000;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        }
                        button {
                            background: #4a90e2;
                            color: white;
                            border: none;
                            padding: 10px 24px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 500;
                            transition: all 0.2s ease;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                        }
                        button:hover {
                            background: #357abd;
                            transform: translateY(-1px);
                            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                        }
                        button:active {
                            transform: translateY(0);
                        }
                        button.whatsapp {
                            background: #25d366;
                        }
                        button.whatsapp:hover {
                            background: #20ba5a;
                        }
                        #slip-container {
                            width: 100%;
                            height: calc(100vh - 50px);
                            border: none;
                            margin-top: 50px;
                            background: white;
                        }
                        @media print {
                            #toolbar { display: none; }
                            #slip-container { margin-top: 0; height: auto; }
                        }
                    </style>
                </head>
                <body>
                    <div id="toolbar">
                        <button onclick="window.print()">
                            <span>üñ®Ô∏è</span>
                            <span>Print</span>
                        </button>
                        <button class="whatsapp" onclick="shareWhatsApp()">
                            <span>üì±</span>
                            <span>Share on WhatsApp</span>
                        </button>
                    </div>
                    <iframe id="slip-container" src="/print/${slipId}"></iframe>

                    <script>
                        const slipId = ${slipId};
                        const mobileNumber = ${mobile ? `'${mobile}'` : 'null'};
                        const billNo = ${bill ? `'${bill}'` : 'null'};

                        function shareWhatsApp() {
                            if (!mobileNumber || mobileNumber === 'null' || mobileNumber.trim() === '') {
                                alert('No mobile number found for this slip.\\n\\nPlease add a mobile number in the slip details and try again.');
                                return;
                            }

                            // Clean mobile number and construct WhatsApp Web URL
                            const cleanMobile = mobileNumber.replace(/[^0-9]/g, '');
                            const whatsappNumber = cleanMobile.startsWith('91') ? cleanMobile : '91' + cleanMobile;

                            // Create WhatsApp message with slip details
                            const message = encodeURIComponent(
                                \`Purchase Slip #\${billNo || slipId}\\n\\n\` +
                                \`View and print your purchase slip here:\\n\` +
                                \`\${window.location.origin}/print/\${slipId}\`
                            );

                            // Open WhatsApp Web with pre-filled message
                            window.open(\`https://wa.me/\${whatsappNumber}?text=\${message}\`, '_blank');
                        }

                        // Keyboard shortcuts
                        document.addEventListener('keydown', (e) => {
                            if (e.ctrlKey && e.key === 'p') {
                                e.preventDefault();
                                window.print();
                            }
                        });
                    </script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        let deleteSlipId = null;

        function deleteSlip(slipId) {
            deleteSlipId = slipId;
            document.getElementById('deleteConfirmText').value = '';
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            deleteModal.show();
        }

        async function confirmDelete() {
            const confirmText = document.getElementById('deleteConfirmText').value.trim();

            if (confirmText !== 'delete') {
                alert('Please type "delete" to confirm deletion');
                return;
            }

            if (!deleteSlipId) {
                alert('No slip selected for deletion');
                return;
            }

            try {
                const response = await fetch(`http://localhost:5000/api/slip/${deleteSlipId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
                    deleteModal.hide();
                    alert('Slip deleted successfully');
                    deleteSlipId = null;
                    loadAllSlips();
                } else {
                    alert('Error deleting slip: ' + result.message);
                }
            } catch (error) {
                console.error('Error deleting slip:', error);
                alert('Error deleting slip');
            }
        }

        async function loadAllUsers() {
            const tbody = document.getElementById('usersTableBody');

            try {
                // Show loading state
                tbody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border spinner-border-sm me-2"></div>Loading users...</td></tr>';

                const response = await fetch('http://localhost:5000/api/users');

                // Check HTTP status
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('Users API Response:', result);

                // Clear loading state
                tbody.innerHTML = '';

                // Check API response
                if (!result.success) {
                    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-warning">‚ö†Ô∏è API Error: ${result.message || 'Unknown error'}</td></tr>`;
                    console.error('API returned error:', result);
                    return;
                }

                // Check if users array exists and has data
                if (!result.users || !Array.isArray(result.users)) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-warning">‚ö†Ô∏è Invalid response format from server</td></tr>';
                    console.error('Invalid users data:', result);
                    return;
                }

                if (result.users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No users found in database.<br><small class="text-muted">Database might be empty or users table not initialized.</small></td></tr>';
                    console.warn('Users array is empty');
                    return;
                }

                // Display users
                result.users.forEach(usr => {
                    const showEditDelete = isAdmin;
                    const row = `
                        <tr>
                            <td>${usr.username}</td>
                            <td>${usr.full_name || '-'}</td>
                            <td><span class="badge bg-${usr.role === 'admin' ? 'danger' : 'primary'}">${usr.role}</span></td>
                            <td>${usr.last_login ? new Date(usr.last_login).toLocaleString() : 'Never'}</td>
                            <td><span class="badge bg-${usr.is_active ? 'success' : 'secondary'}">${usr.is_active ? 'Active' : 'Inactive'}</span></td>
                            <td>
                                ${showEditDelete ? `
                                    <button class="btn btn-sm btn-warning" onclick="showEditUserModal(${usr.id})">Edit</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteUser(${usr.id})" ${usr.username === 'admin' ? 'disabled' : ''}>Delete</button>
                                ` : '<span class="text-muted">No access</span>'}
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                console.log(`‚úÖ Loaded ${result.users.length} users successfully`);

            } catch (error) {
                console.error('‚ùå Error loading users:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger">
                            <strong>‚ùå Connection Error</strong><br>
                            ${error.message}<br>
                            <small class="text-muted mt-2 d-block">
                                ‚Ä¢ Make sure Flask server is running on port 5000<br>
                                ‚Ä¢ Check backend/app.py is started<br>
                                ‚Ä¢ Check browser console (F12) for details
                            </small>
                        </td>
                    </tr>
                `;
            }
        }

        function showAddUserModal() {
            document.getElementById('addUserForm').reset();
            new bootstrap.Modal(document.getElementById('addUserModal')).show();
        }

        async function addUser() {
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value.trim();
            const fullName = document.getElementById('newFullName').value.trim();
            const role = document.getElementById('newRole').value;

            if (!username || !password) {
                alert('Username and password are required');
                return;
            }

            try {
                const response = await fetch('http://localhost:5000/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username,
                        password,
                        full_name: fullName,
                        role,
                        requesting_user_role: user.role
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('User added successfully');
                    bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
                    document.getElementById('addUserForm').reset();
                    loadAllUsers();
                } else {
                    alert('Error adding user: ' + result.message);
                }
            } catch (error) {
                console.error('Error adding user:', error);
                alert('Error adding user');
            }
        }

        async function showEditUserModal(userId) {
            try {
                const response = await fetch('http://localhost:5000/api/users');
                const result = await response.json();

                if (result.success) {
                    const usr = result.users.find(u => u.id === userId);
                    if (usr) {
                        document.getElementById('editUserId').value = usr.id;
                        document.getElementById('editUsername').value = usr.username;
                        document.getElementById('editFullName').value = usr.full_name || '';
                        document.getElementById('editUserRole').value = usr.role;
                        document.getElementById('editUserStatus').value = usr.is_active.toString();
                        document.getElementById('editUserPassword').value = '';

                        new bootstrap.Modal(document.getElementById('editUserModal')).show();
                    }
                }
            } catch (error) {
                console.error('Error loading user:', error);
                alert('Error loading user details');
            }
        }

        async function updateUser() {
            const userId = document.getElementById('editUserId').value;
            const fullName = document.getElementById('editFullName').value.trim();
            const role = document.getElementById('editUserRole').value;
            const isActive = document.getElementById('editUserStatus').value === 'true';
            const password = document.getElementById('editUserPassword').value.trim();

            try {
                const response = await fetch(`http://localhost:5000/api/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        full_name: fullName,
                        role,
                        is_active: isActive,
                        password: password || undefined,
                        requesting_user_role: user.role
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('User updated successfully');
                    bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                    loadAllUsers();
                } else {
                    alert('Error updating user: ' + result.message);
                }
            } catch (error) {
                console.error('Error updating user:', error);
                alert('Error updating user');
            }
        }

        async function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                try {
                    const response = await fetch(`http://localhost:5000/api/users/${userId}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ requesting_user_role: user.role })
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('User deleted successfully');
                        loadAllUsers();
                    } else {
                        alert('Error deleting user: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('Error deleting user');
                }
            }
        }
        // ==================== DASHBOARD FUNCTIONS ====================

        let dashboardCharts = {};

        async function loadDashboardData() {
            try {
                const period = document.getElementById('dashboardPeriod').value;
                console.log('Loading dashboard data for period:', period);
                const response = await fetch(`http://localhost:5000/api/dashboard?period=${period}`);
                const data = await response.json();
                console.log('Dashboard data received:', data);

                if (data.success) {
                    console.log('Updating dashboard UI...');
                    updateMetricsCards(data.metrics);
                    updateCharts(data);
                    updateOutstandingTable(data.outstanding);
                    console.log('Dashboard updated successfully');
                } else {
                    console.error('Dashboard API returned error:', data.message);
                    alert('Failed to load dashboard data: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                alert('Failed to load dashboard data. Please check the console for details.');
            }
        }

        function updateMetricsCards(metrics) {
            console.log('Updating metrics cards:', metrics);
            document.getElementById('totalPaddyQntl').textContent = `${parseFloat(metrics.totalPaddyQntl || 0).toFixed(2)} Qntl`;
            document.getElementById('totalPurchaseAmount').textContent = `‚Çπ${parseFloat(metrics.totalPurchaseAmount || 0).toFixed(2)}`;
            document.getElementById('totalDeductions').textContent = `‚Çπ${parseFloat(metrics.totalDeductions || 0).toFixed(2)}`;
            document.getElementById('netPayable').textContent = `‚Çπ${parseFloat(metrics.netPayable || 0).toFixed(2)}`;
            document.getElementById('totalPaid').textContent = `‚Çπ${parseFloat(metrics.totalPaid || 0).toFixed(2)}`;
            document.getElementById('totalOutstanding').textContent = `‚Çπ${parseFloat(metrics.totalOutstanding || 0).toFixed(2)}`;
            document.getElementById('avgEffectiveRate').textContent = `‚Çπ${parseFloat(metrics.avgEffectiveRate || 0).toFixed(2)}/Qntl`;
            document.getElementById('totalBills').textContent = parseInt(metrics.totalBills || 0);
        }

        function updateCharts(data) {
            console.log('Updating charts with data:', data);

            // Daily Purchase Trend Chart
            destroyChart('dailyPurchaseChart');
            const dailyCtx = document.getElementById('dailyPurchaseChart').getContext('2d');
            dashboardCharts['dailyPurchaseChart'] = new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: (data.dailyPurchase?.dates || []).length > 0 ? data.dailyPurchase.dates : ['No Data'],
                    datasets: [{
                        label: 'Quantity (Qntl)',
                        data: (data.dailyPurchase?.quantities || []).length > 0 ? data.dailyPurchase.quantities : [0],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Rate Trend Chart
            destroyChart('rateTrendChart');
            const rateCtx = document.getElementById('rateTrendChart').getContext('2d');
            dashboardCharts['rateTrendChart'] = new Chart(rateCtx, {
                type: 'line',
                data: {
                    labels: (data.rateTrend?.dates || []).length > 0 ? data.rateTrend.dates : ['No Data'],
                    datasets: [{
                        label: 'Rate (‚Çπ/Qntl)',
                        data: (data.rateTrend?.rates || []).length > 0 ? data.rateTrend.rates : [0],
                        borderColor: '#f6ad55',
                        backgroundColor: 'rgba(246, 173, 85, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Deduction Breakdown Chart
            destroyChart('deductionChart');
            const deductionCtx = document.getElementById('deductionChart').getContext('2d');
            dashboardCharts['deductionChart'] = new Chart(deductionCtx, {
                type: 'bar',
                data: {
                    labels: data.deductions?.labels || ['Moisture', 'Quality', 'Dalali', 'Hammali', 'Commission', 'Freight'],
                    datasets: [{
                        label: 'Amount (‚Çπ)',
                        data: data.deductions?.amounts || [0, 0, 0, 0, 0, 0],
                        backgroundColor: [
                            '#fc8181',
                            '#f6ad55',
                            '#f6e05e',
                            '#68d391',
                            '#4fd1c5',
                            '#63b3ed'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Top Suppliers Chart
            destroyChart('topSuppliersChart');
            const suppliersCtx = document.getElementById('topSuppliersChart').getContext('2d');
            dashboardCharts['topSuppliersChart'] = new Chart(suppliersCtx, {
                type: 'bar',
                data: {
                    labels: (data.topSuppliers?.names || []).length > 0 ? data.topSuppliers.names : ['No Data'],
                    datasets: [{
                        label: 'Quantity (Qntl)',
                        data: (data.topSuppliers?.quantities || []).length > 0 ? data.topSuppliers.quantities : [0],
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Outstanding Ageing Chart
            destroyChart('ageingChart');
            const ageingCtx = document.getElementById('ageingChart').getContext('2d');
            dashboardCharts['ageingChart'] = new Chart(ageingCtx, {
                type: 'doughnut',
                data: {
                    labels: ['0-7 days', '7-30 days', '30-60 days', '60+ days'],
                    datasets: [{
                        data: data.ageing?.amounts || [0, 0, 0, 0],
                        backgroundColor: ['#48bb78', '#ed8936', '#f6e05e', '#fc8181']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true
                }
            });

            // Payment Mode Chart
            destroyChart('paymentModeChart');
            const paymentCtx = document.getElementById('paymentModeChart').getContext('2d');
            dashboardCharts['paymentModeChart'] = new Chart(paymentCtx, {
                type: 'pie',
                data: {
                    labels: data.paymentMode?.modes || ['Cash', 'Online Transfer', 'Cheque'],
                    datasets: [{
                        data: data.paymentMode?.amounts || [0, 0, 0],
                        backgroundColor: ['#667eea', '#48bb78', '#ed8936']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true
                }
            });

            // Godown Stock Chart
            destroyChart('godownStockChart');
            const godownCtx = document.getElementById('godownStockChart').getContext('2d');
            dashboardCharts['godownStockChart'] = new Chart(godownCtx, {
                type: 'bar',
                data: {
                    labels: data.godownStock?.godowns || ['No Data'],
                    datasets: [{
                        label: 'Stock (Qntl)',
                        data: data.godownStock?.quantities || [0],
                        backgroundColor: '#764ba2'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Rice Output Chart
            destroyChart('riceOutputChart');
            const riceCtx = document.getElementById('riceOutputChart').getContext('2d');
            const totalPaddy = data.metrics?.totalPaddyQntl || 0;
            dashboardCharts['riceOutputChart'] = new Chart(riceCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Rice (67%)', 'Husk (22%)', 'Bran (10%)', 'Loss (1%)'],
                    datasets: [{
                        data: [
                            totalPaddy * 0.67,
                            totalPaddy * 0.22,
                            totalPaddy * 0.10,
                            totalPaddy * 0.01
                        ],
                        backgroundColor: ['#48bb78', '#ed8936', '#f6e05e', '#cbd5e0']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true
                }
            });
        }

        function destroyChart(chartId) {
            if (dashboardCharts[chartId]) {
                dashboardCharts[chartId].destroy();
            }
        }

        function updateOutstandingTable(outstanding) {
            const tbody = document.getElementById('outstandingTableBody');
            if (!outstanding || outstanding.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No outstanding payments</td></tr>';
                return;
            }

            tbody.innerHTML = outstanding.map(item => {
                const statusClass = item.daysOverdue > 60 ? 'danger' : (item.daysOverdue > 30 ? 'warning' : 'success');
                const statusText = item.daysOverdue > 60 ? 'Overdue' : (item.daysOverdue > 30 ? 'Due Soon' : 'Current');

                return `
                    <tr>
                        <td>${item.farmerName}</td>
                        <td class="text-end">‚Çπ${parseFloat(item.totalPurchase || 0).toFixed(2)}</td>
                        <td class="text-end">‚Çπ${parseFloat(item.totalPaid || 0).toFixed(2)}</td>
                        <td class="text-end"><strong>‚Çπ${parseFloat(item.outstanding || 0).toFixed(2)}</strong></td>
                        <td>${item.lastPaymentDate || 'N/A'}</td>
                        <td class="text-center"><span class="stat-badge ${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // Load dashboard on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadDashboardData();
        });

    </script>
</body>
</html>


<!-- <tr><td>Ticket No</td><td>${slip.ticket_no || '-'}</td></tr> -->
